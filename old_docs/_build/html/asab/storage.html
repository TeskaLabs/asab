
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Storage &#8212; ASAB  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Alert Service" href="alert.html" />
    <link rel="prev" title="Metrics" href="metrics.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="storage">
<h1>Storage<a class="headerlink" href="#storage" title="Permalink to this heading">¶</a></h1>
<p>The ASAB’s Storage Service supports data storage in-memory or in dedicated document databases, including  <a class="reference external" href="https://www.mongodb.com/">MongoDB</a> and <a class="reference external" href="https://www.elastic.co/">ElasticSearch</a>.</p>
<section id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this heading">¶</a></h2>
<p>First, specify the storage type in the configuration. The options for the storage type are:</p>
<ul class="simple">
<li><p><cite>inmemory</cite>: Collects data directly in memory</p></li>
<li><p><cite>mongodb</cite>: Collects data using MongoDB database. Depends on <a class="reference external" href="https://pymongo.readthedocs.io/en/stable/">pymongo</a> and <a class="reference external" href="https://motor.readthedocs.io/en/stable/api-asyncio/asyncio_motor_collection.html">motor</a> libraries.</p></li>
<li><p><cite>elasticsearch</cite>: Collects data using ElasticSearch database. Depends on <a class="reference external" href="https://docs.aiohttp.org/en/latest/">aiohttp</a> library.</p></li>
</ul>
<p>Storage Service provides a unified interface for accessing and manipulating collections across multiple database technologies.</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[asab:storage]</span><span class="w"></span>
<span class="na">type</span><span class="o">=</span><span class="s">mongodb</span><span class="w"></span>
</pre></div>
</div>
<p>For accessing the storage, simply add <cite>asab.storage.Module`</cite> when initializing and register the service.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyApplication</span><span class="p">(</span><span class="n">asab</span><span class="o">.</span><span class="n">Application</span><span class="p">):</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="n">asab</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">Module</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">storage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_service</span><span class="p">(</span><span class="s2">&quot;asab.StorageService&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="manipulation-with-databases">
<h2>Manipulation with databases<a class="headerlink" href="#manipulation-with-databases" title="Permalink to this heading">¶</a></h2>
<section id="upsertor">
<h3>Upsertor<a class="headerlink" href="#upsertor" title="Permalink to this heading">¶</a></h3>
<p>Upsertor is an object that works like a pointer to the specified database and optionally to object id. It is used for inserting new objects, updating existing objects and deleting them.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">u</span> <span class="o">=</span> <span class="n">storage</span><span class="o">.</span><span class="n">upsertor</span><span class="p">(</span><span class="s2">&quot;test-collection&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="xref py py-func docutils literal notranslate"><span class="pre">StorageService.upsertor()</span></code> method creates an upsertor object associated with the specified collection. It takes <cite>collection</cite> as an argument and can have two parameters <cite>obj_id</cite> and <cite>version</cite>, which are used for getting an existing object by its ID and version.</p>
</section>
<section id="inserting-an-object">
<h3>Inserting an object<a class="headerlink" href="#inserting-an-object" title="Permalink to this heading">¶</a></h3>
<p>For inserting an object to the collection, use the <code class="xref py py-func docutils literal notranslate"><span class="pre">Upsertor.set()</span></code> method.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">u</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>To execute these procedures, simply run the <code class="xref py py-func docutils literal notranslate"><span class="pre">Upsertor.execute()</span></code> coroutine method, which commits the upsertor data to the storage and returns the ID of the object. Since it is a coroutine, it must be awaited.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">object_id</span> <span class="o">=</span> <span class="k">await</span> <span class="n">u</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</pre></div>
</div>
<p>The <cite>Upsertor.execute()</cite> method has optional parameters <cite>custom_data</cite> and <cite>event_type</cite>, which are used for webhook requests.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">object_id</span> <span class="o">=</span> <span class="k">await</span> <span class="n">u</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="n">custom_data</span><span class="o">=</span> <span class="p">{</span><span class="s2">&quot;foo&quot;</span><span class="p">:</span> <span class="s2">&quot;bar&quot;</span><span class="p">},</span>
    <span class="n">event_type</span><span class="o">=</span><span class="s2">&quot;object_created&quot;</span>
    <span class="p">)</span>
</pre></div>
</div>
</section>
<section id="getting-a-single-object">
<h3>Getting a single object<a class="headerlink" href="#getting-a-single-object" title="Permalink to this heading">¶</a></h3>
<p>For getting a single object, use <code class="xref py py-func docutils literal notranslate"><span class="pre">StorageService.get()</span></code> coroutine method that takes two arguments <cite>collection</cite> and <cite>obj_id</cite> and finds an object by its ID in collection.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">obj</span> <span class="o">=</span> <span class="k">await</span> <span class="n">storage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">collection</span><span class="o">=</span><span class="s2">&quot;test-collection&quot;</span><span class="p">,</span> <span class="n">obj_id</span><span class="o">=</span><span class="n">object_id</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</pre></div>
</div>
<p>When the requested object is not found in the collection, the method raises <code class="docutils literal notranslate"><span class="pre">KeyError</span></code>. Remember to handle this exception properly when using databases in your services and prevent them from crashing!</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>MongoDB storage service in addition provides a coroutine method <code class="xref py py-func docutils literal notranslate"><span class="pre">get_by()</span></code> which is used for accessing an object by finding its key-value pair.</p>
</div>
</section>
<section id="updating-an-object">
<h3>Updating an object<a class="headerlink" href="#updating-an-object" title="Permalink to this heading">¶</a></h3>
<p>For updating an object, first obtain the upsertor specifying its <cite>obj_id</cite> and <cite>version</cite>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">u</span> <span class="o">=</span> <span class="n">storage</span><span class="o">.</span><span class="n">upsertor</span><span class="p">(</span>
    <span class="n">collection</span><span class="o">=</span><span class="s2">&quot;test-collection&quot;</span><span class="p">,</span>
    <span class="n">obj_id</span><span class="o">=</span><span class="n">object_id</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;_v&#39;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
<p>We strongly recommend to read the version from the object such as above. That creates a soft lock on the record. It means that if the object is updated by other component in meanwhile, your upsertor will fail and you should retry the whole operation. The new objects should have a version set to 0, which is done by default.</p>
<p>After obtaining an upsertor, you can update the object via the <code class="xref py py-func docutils literal notranslate"><span class="pre">Upsertor.set()</span></code> coroutine.</p>
</section>
<section id="deleting-an-object">
<h3>Deleting an object<a class="headerlink" href="#deleting-an-object" title="Permalink to this heading">¶</a></h3>
<p>For deleting an object from database, use the <code class="xref py py-func docutils literal notranslate"><span class="pre">StorageService.delete()</span></code> coroutine method which takes arguments <cite>collection</cite> and <cite>obj_id</cite>, deletes the object and returns its ID.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">deleted_id</span> <span class="o">=</span> <span class="k">await</span> <span class="n">u</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">&quot;test-collection&quot;</span><span class="p">,</span> <span class="n">object_id</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="storing-data-in-memory">
<h2>Storing data in memory<a class="headerlink" href="#storing-data-in-memory" title="Permalink to this heading">¶</a></h2>
<p>If the option <cite>inmemory</cite> is set, ASAB will store data in its own memory. In particular, <cite>asab.StorageService</cite> is initialized with an attribute <cite>InMemoryCollections</cite> which is a dictionary where all the collections are stored in.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can go through all the databases directly by accessing <cite>InMemoryCollections</cite> attribute, although we do not recommend that.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pprint</span>

<span class="n">storage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_service</span><span class="p">(</span><span class="s2">&quot;asab.StorageService&quot;</span><span class="p">)</span>
<span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">storage</span><span class="o">.</span><span class="n">InMemoryCollections</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="storing-data-in-mongodb">
<h2>Storing data in MongoDB<a class="headerlink" href="#storing-data-in-mongodb" title="Permalink to this heading">¶</a></h2>
<p>If the option <cite>mongodb</cite> is set, ASAB will store data in MongoDB database.</p>
<p>ASAB uses <a class="reference external" href="https://pypi.org/project/motor/">motor library</a> which provides non-blocking MongoDB driver for <cite>asyncio</cite>.</p>
<p>You can specify the database name and URL for MongoDB in config file (the following example is the default configuration):</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[asab:storage]</span><span class="w"></span>
<span class="na">type</span><span class="o">=</span><span class="s">mongodb</span><span class="w"></span>
<span class="na">mongodb_uri</span><span class="o">=</span><span class="s">mongodb://localhost:27017</span><span class="w"></span>
<span class="na">mongodb_database</span><span class="o">=</span><span class="s">asabdb</span><span class="w"></span>
</pre></div>
</div>
<p>You can use all the methods from the abstract class. MongoDB Storage class provides in addition two methods, <code class="xref py py-func docutils literal notranslate"><span class="pre">StorageService.get_by()</span></code> and <code class="xref py py-func docutils literal notranslate"><span class="pre">StorageService.collection()</span></code>.</p>
<p>The method <code class="xref py py-func docutils literal notranslate"><span class="pre">StorageService.get_by()</span></code> is used in the same way as <code class="xref py py-func docutils literal notranslate"><span class="pre">StorageService.get()</span></code> except that it takes the arguments <cite>key</cite> and <cite>value</cite> instead of <cite>obj_id</cite>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">obj</span> <span class="o">=</span> <span class="k">await</span> <span class="n">storage</span><span class="o">.</span><span class="n">get_by</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="s2">&quot;test-collection&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The method <code class="xref py py-func docutils literal notranslate"><span class="pre">collection()</span></code> is used for accessing the database directly. It takes <cite>collection</cite> as the argument and returns <cite>motor.motor_asyncio.AsyncIOMotorCollection</cite> object, which can be used for calling MongoDB directives.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">collection</span> <span class="o">=</span> <span class="k">await</span> <span class="n">storage</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="s2">&quot;test-collection&quot;</span><span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="p">({})</span>
<span class="k">while</span> <span class="k">await</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetch_next</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">next_object</span><span class="p">()</span>
    <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<p>The full list of methods suitable for this object is described in the <a class="reference external" href="https://motor.readthedocs.io/en/stable/api-asyncio/asyncio_motor_collection.html">official documentation</a>.</p>
</section>
<section id="storing-data-in-elasticsearch">
<h2>Storing data in ElasticSearch<a class="headerlink" href="#storing-data-in-elasticsearch" title="Permalink to this heading">¶</a></h2>
<p>When using ElasticSearch, add configurations for URL, username and password.</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[asab:storage]</span><span class="w"></span>
<span class="na">type</span><span class="o">=</span><span class="s">elasticsearch</span><span class="w"></span>
<span class="na">elasticsearch_url</span><span class="o">=</span><span class="s">http://localhost:9200/</span><span class="w"></span>
<span class="na">elasticsearch_username</span><span class="o">=</span><span class="s">JohnDoe</span><span class="w"></span>
<span class="na">elasticsearch_password</span><span class="o">=</span><span class="s">lorem_ipsum_dolor?sit_amet!2023</span><span class="w"></span>
</pre></div>
</div>
<p>You can also specify the <a class="reference external" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-refresh.html#docs-refresh">refreshing parameter</a> and scroll timeout for <a class="reference external" href="https://www.elastic.co/guide/en/elasticsearch//reference/current/scroll-api.html">ElasticSearch Scroll API</a>.</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[asab:storage]</span><span class="w"></span>
<span class="na">refresh</span><span class="o">=</span><span class="s">true</span><span class="w"></span>
<span class="na">scroll_timeout</span><span class="o">=</span><span class="s">1m</span><span class="w"></span>
</pre></div>
</div>
<p>ElasticSearch Storage provides in addition other methods for creating index templates, mappings etc (see the Reference section).</p>
</section>
<section id="encryption-and-decryption">
<h2>Encryption and decryption<a class="headerlink" href="#encryption-and-decryption" title="Permalink to this heading">¶</a></h2>
<p>Data stored in the database can be encrypted using an algorithm that adheres to the Advanced Encryption Standard (AES).</p>
<section id="aes-key-settings">
<h3>AES Key settings<a class="headerlink" href="#aes-key-settings" title="Permalink to this heading">¶</a></h3>
<p>In order to use encryption, first make sure you have the <a class="reference external" href="https://pypi.org/project/cryptography/">cryptography package</a> installed. Then specify the AES Key in the config file.</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[asab:storage]</span><span class="w"></span>
<span class="na">aes_key</span><span class="o">=</span><span class="s">random_key_string</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The AES Key is used as both an encryption and decryption key. It is recommended to keep it in <a class="reference external" href="https://asab.readthedocs.io/en/latest/asab/config.html#including-other-configuration-files">a separate configuration file</a> that is not exposed anywhere publicly.</p>
<p>The actual binary AES Key is obtained from the <cite>aes_key</cite> specified in the config file by encoding and hashing it using the standard <a class="reference external" href="https://docs.python.org/3/library/hashlib.html">hashlib</a> algorithms, so do not worry about the length and type of the key.</p>
</div>
</section>
<section id="encrypting-data">
<h3>Encrypting data<a class="headerlink" href="#encrypting-data" title="Permalink to this heading">¶</a></h3>
<p>The <code class="xref py py-func docutils literal notranslate"><span class="pre">Upsertor.set()</span></code> method has an optional boolean parameter <cite>encrypt</cite> for encrypting the data before they are stored. Only values of the type <code class="docutils literal notranslate"><span class="pre">bytes</span></code> can be encrypted. If you want to encrypt other values, encode them first.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;This is a super secret message!&quot;</span>
<span class="n">number</span> <span class="o">=</span> <span class="mi">2023</span>
<span class="n">message_binary</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span>
<span class="n">number_binary</span> <span class="o">=</span> <span class="n">number</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span>

<span class="n">u</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="n">message_binary</span><span class="p">,</span> <span class="n">encrypt</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">u</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="n">number_binary</span><span class="p">,</span> <span class="n">encrypt</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">object_id</span> <span class="o">=</span> <span class="k">await</span> <span class="n">u</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="decrypting-data">
<h3>Decrypting data<a class="headerlink" href="#decrypting-data" title="Permalink to this heading">¶</a></h3>
<p>The <code class="xref py py-func docutils literal notranslate"><span class="pre">StorageService.get()</span></code> coroutine method has an optional parameter <cite>decrypt</cite> which takes an <code class="docutils literal notranslate"><span class="pre">iterable</span></code> object (i.e. a list, tuple, set, …)  with the names of keys whose values are to be decrypted.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">storage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
    <span class="n">collection</span><span class="o">=</span><span class="s2">&quot;test-collection&quot;</span><span class="p">,</span>
    <span class="n">obj_id</span><span class="o">=</span><span class="n">object_id</span><span class="p">,</span>
    <span class="n">decrypt</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="s2">&quot;number&quot;</span><span class="p">]</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>If some of the keys to be decrypted are missing in the required document, the method will ignore them and continue.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Data that has been encrypted can be identified by the prefix “$aes-cbc$” and are stored in a binary format.</p>
</div>
</section>
<section id="under-the-hood">
<h3>Under the hood<a class="headerlink" href="#under-the-hood" title="Permalink to this heading">¶</a></h3>
<p>For encrypting data, we use the certified symmetric AES-CBC algorithm. In fact, the abstract base class <code class="xref py py-class docutils literal notranslate"><span class="pre">StorageServiceABC</span></code> provides two methods <code class="xref py py-func docutils literal notranslate"><span class="pre">aes_encrypt()</span></code> and <code class="xref py py-func docutils literal notranslate"><span class="pre">aes_decrypt()</span></code> that are called automatically in <code class="xref py py-func docutils literal notranslate"><span class="pre">Upsertor.set()</span></code> and <code class="xref py py-func docutils literal notranslate"><span class="pre">StorageService.get()</span></code> methods when the parameter <cite>encrypt</cite> or <cite>decrypt</cite> is specified.</p>
<p>AES-CBC is a mode of operation for the Advanced Encryption Standard (AES) algorithm that provides confidentiality and integrity for data. In AES-CBC, the plaintext is divided into blocks of fixed size (usually 128 bits), and each block is encrypted using the AES algorithm with a secret key.</p>
<p>CBC stands for “Cipher Block Chaining” and it is a technique that adds an extra step to the encryption process to ensure that each ciphertext block depends on the previous one. This means that any modification to the ciphertext will produce a completely different plaintext after decryption.</p>
<p>The algorithm is a symmetric cipher, which is suitable for encrypting large amounts of data. It requires much less computation power than asymmetric ciphers and is much more useful for bulk encrypting large amounts of data.</p>
</section>
</section>
<section id="reference">
<h2>Reference<a class="headerlink" href="#reference" title="Permalink to this heading">¶</a></h2>
<section id="storageservice">
<h3>StorageService<a class="headerlink" href="#storageservice" title="Permalink to this heading">¶</a></h3>
<p>Here is a list of methods of the abstract StorageService class which can be used for all types of storages.</p>
<dl class="py class">
<dt class="sig sig-object py" id="asab.storage.service.StorageServiceABC">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">asab.storage.service.</span></span><span class="sig-name descname"><span class="pre">StorageServiceABC</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">app</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">service_name</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/asab/storage/service.html#StorageServiceABC"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#asab.storage.service.StorageServiceABC" title="Permalink to this definition">¶</a></dt>
<dd><dl class="py method">
<dt class="sig sig-object py" id="asab.storage.service.StorageServiceABC.upsertor">
<em class="property"><span class="pre">abstract</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">upsertor</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">collection</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">obj_id</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">version</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">0</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/asab/storage/service.html#StorageServiceABC.upsertor"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#asab.storage.service.StorageServiceABC.upsertor" title="Permalink to this definition">¶</a></dt>
<dd><p>Create an upsertor object for the specified collection.</p>
<p>If updating an existing object, please specify its <cite>obj_id</cite> and also <cite>version</cite> that you need to read from a storage upfront.
If <cite>obj_id</cite> is None, we assume that you want to insert a new object and generate its new <cite>obj_id</cite>, <cite>version</cite> should be set to 0 (default) in that case.
If you want to insert a new object with a specific <cite>obj_id</cite>, specify <cite>obj_id</cite> and set a version to 0.</p>
<blockquote>
<div><ul class="simple">
<li><p>If there will be a colliding object already stored in a storage, <cite>execute()</cite> method will fail on <cite>DuplicateError</cite>.</p></li>
</ul>
</div></blockquote>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>collection</strong> – Name of collection to work with</p></li>
<li><p><strong>obj_id</strong> – Primary identification of an object in the storage (e.g. primary key)</p></li>
<li><p><strong>version</strong> – Specify a current version of the object and hence prevent byzantine faults.             You should always read the version from the storage upfront, prior using an upsertor.           That creates a soft lock on the record. It means that if the object is updated by other                 component in meanwhile, your upsertor will fail and you should retry the whole operation.               The new objects should have a <cite>version</cite> set to 0.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="asab.storage.service.StorageServiceABC.get">
<em class="property"><span class="pre">abstract</span><span class="w"> </span><span class="pre">async</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">get</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">collection</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">obj_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">decrypt</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">dict</span></span></span><a class="reference internal" href="../_modules/asab/storage/service.html#StorageServiceABC.get"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#asab.storage.service.StorageServiceABC.get" title="Permalink to this definition">¶</a></dt>
<dd><p>Get object from collection by its ID.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>collection</strong> (<em>str</em>) – Collection to get from.</p></li>
<li><p><strong>obj_id</strong> – Object identification.</p></li>
<li><p><strong>decrypt</strong> – Set of fields to decrypt.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>The object retrieved from a storage.</p>
</dd>
<dt class="field-odd">Raises<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>KeyError</strong> – Raised if <cite>obj_id</cite> is not found in <cite>collection</cite>.</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="asab.storage.service.StorageServiceABC.delete">
<em class="property"><span class="pre">abstract</span><span class="w"> </span><span class="pre">async</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">delete</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">collection</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">obj_id</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/asab/storage/service.html#StorageServiceABC.delete"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#asab.storage.service.StorageServiceABC.delete" title="Permalink to this definition">¶</a></dt>
<dd><p>Delete object from collection.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>collection</strong> (<em>str</em>) – Collection to get from</p></li>
<li><p><strong>obj_id</strong> – Object identification</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>ID of the deleted object.</p>
</dd>
<dt class="field-odd">Raises<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>KeyError</strong> – Raised when obj_id cannot be found in collection.</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="asab.storage.service.StorageServiceABC.aes_encrypt">
<span class="sig-name descname"><span class="pre">aes_encrypt</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">raw</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bytes</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">iv</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bytes</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">bytes</span></span></span><a class="reference internal" href="../_modules/asab/storage/service.html#StorageServiceABC.aes_encrypt"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#asab.storage.service.StorageServiceABC.aes_encrypt" title="Permalink to this definition">¶</a></dt>
<dd><p>Take an array of bytes and encrypt it using AES-CBC.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>raw</strong> (<em>bytes</em>) – The data to be encrypted.</p></li>
<li><p><strong>iv</strong> (<em>bytes</em>) – AES-CBC initialization vector, 16 bytes long. If left empty, a random 16-byte array will be used.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>The encrypted data.</p>
</dd>
<dt class="field-odd">Raises<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>TypeError</strong> – The data are not in binary format.</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="asab.storage.service.StorageServiceABC.aes_decrypt">
<span class="sig-name descname"><span class="pre">aes_decrypt</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">encrypted</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bytes</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">bytes</span></span></span><a class="reference internal" href="../_modules/asab/storage/service.html#StorageServiceABC.aes_decrypt"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#asab.storage.service.StorageServiceABC.aes_decrypt" title="Permalink to this definition">¶</a></dt>
<dd><p>Decrypt encrypted data using AES-CBC.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>encrypted</strong> (<em>bytes</em>) – The encrypted data to decrypt.
It must start with b”$aes-cbc$” prefix, followed by one-block-long initialization vector.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>The decrypted data.</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

</section>
<section id="id1">
<h3>Upsertor<a class="headerlink" href="#id1" title="Permalink to this heading">¶</a></h3>
<p>Here is a list of methods of the abstract Upsertor class which can be used for all types of storages.</p>
<dl class="py class">
<dt class="sig sig-object py" id="asab.storage.upsertor.UpsertorABC">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">asab.storage.upsertor.</span></span><span class="sig-name descname"><span class="pre">UpsertorABC</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">storage</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">collection</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">obj_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">version</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/asab/storage/upsertor.html#UpsertorABC"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#asab.storage.upsertor.UpsertorABC" title="Permalink to this definition">¶</a></dt>
<dd><dl class="py method">
<dt class="sig sig-object py" id="asab.storage.upsertor.UpsertorABC.set">
<span class="sig-name descname"><span class="pre">set</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">objField</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">value</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">encrypt</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">encrypt_iv</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/asab/storage/upsertor.html#UpsertorABC.set"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#asab.storage.upsertor.UpsertorABC.set" title="Permalink to this definition">¶</a></dt>
<dd><p>Add key and value to the upsertor.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>objField</strong> – Key of the object.</p></li>
<li><p><strong>value</strong> – Value of the object.</p></li>
<li><p><strong>encrypt</strong> (<em>bool</em>) – Allow encryption. Defaults to False.</p></li>
<li><p><strong>encrypt_iv</strong> (<em>bool</em>) – Custom initialization vector. Defaults to None.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="asab.storage.upsertor.UpsertorABC.unset">
<span class="sig-name descname"><span class="pre">unset</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">obj_field</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/asab/storage/upsertor.html#UpsertorABC.unset"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#asab.storage.upsertor.UpsertorABC.unset" title="Permalink to this definition">¶</a></dt>
<dd><p>Scalar unset</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="asab.storage.upsertor.UpsertorABC.generate_id">
<em class="property"><span class="pre">classmethod</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">generate_id</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">bytes</span></span></span><a class="reference internal" href="../_modules/asab/storage/upsertor.html#UpsertorABC.generate_id"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#asab.storage.upsertor.UpsertorABC.generate_id" title="Permalink to this definition">¶</a></dt>
<dd><p>Generate a unique ID string using a combination of a random UUID and a SHA-256 hash.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p>A string representation of the generated ID.</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="asab.storage.upsertor.UpsertorABC.execute">
<em class="property"><span class="pre">abstract</span><span class="w"> </span><span class="pre">async</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">execute</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">custom_data</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">dict</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">event_type</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/asab/storage/upsertor.html#UpsertorABC.execute"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#asab.storage.upsertor.UpsertorABC.execute" title="Permalink to this definition">¶</a></dt>
<dd><p>Commit upsertor data to the storage. Afterwards, send a webhook request with upsertion details.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>custom_data</strong> – Custom execution data. Included in webhook payload.</p></li>
<li><p><strong>event_type</strong> – Event type included in webhook payload.</p></li>
</ul>
</dd>
<dt class="field-even">Raises<span class="colon">:</span></dt>
<dd class="field-even"><p><strong>DuplicateError</strong> – Raised if  thre is a colliding object already stored in a storage.</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

</section>
<section id="in-memory-storage">
<h3>In-memory storage<a class="headerlink" href="#in-memory-storage" title="Permalink to this heading">¶</a></h3>
<p>Here is a list of methods that are specific for the in-memory storage.</p>
<dl class="py class">
<dt class="sig sig-object py" id="asab.storage.inmemory.StorageService">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">asab.storage.inmemory.</span></span><span class="sig-name descname"><span class="pre">StorageService</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">app</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">service_name</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/asab/storage/inmemory.html#StorageService"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#asab.storage.inmemory.StorageService" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <a class="reference internal" href="#asab.storage.service.StorageServiceABC" title="asab.storage.service.StorageServiceABC"><code class="xref py py-class docutils literal notranslate"><span class="pre">StorageServiceABC</span></code></a></p>
</dd></dl>

</section>
<section id="mongodb-storage">
<h3>MongoDB Storage<a class="headerlink" href="#mongodb-storage" title="Permalink to this heading">¶</a></h3>
<p>Here is a list of methods that are specific for the MongoDB storage.</p>
<dl class="py class">
<dt class="sig sig-object py" id="asab.storage.mongodb.StorageService">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">asab.storage.mongodb.</span></span><span class="sig-name descname"><span class="pre">StorageService</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">app</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">service_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">config_section_name</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'asab:storage'</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/asab/storage/mongodb.html#StorageService"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#asab.storage.mongodb.StorageService" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <a class="reference internal" href="#asab.storage.service.StorageServiceABC" title="asab.storage.service.StorageServiceABC"><code class="xref py py-class docutils literal notranslate"><span class="pre">StorageServiceABC</span></code></a></p>
<p>StorageService for MongoDB. Depends on <cite>pymongo</cite> and <cite>motor</cite>.</p>
<dl class="py method">
<dt class="sig sig-object py" id="asab.storage.mongodb.StorageService.get_by">
<em class="property"><span class="pre">async</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">get_by</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">collection</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">key</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">value</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">decrypt</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">dict</span></span></span><a class="reference internal" href="../_modules/asab/storage/mongodb.html#StorageService.get_by"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#asab.storage.mongodb.StorageService.get_by" title="Permalink to this definition">¶</a></dt>
<dd><p>Get object from collection by its key and value.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>collection</strong> – Collection to get from.</p></li>
<li><p><strong>key</strong> – Key to filter on.</p></li>
<li><p><strong>value</strong> – Value to filter on.</p></li>
<li><p><strong>decrypt</strong> – Set of fields to decrypt.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>The object retrieved from a storage</p>
</dd>
<dt class="field-odd">Raises<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>KeyError</strong> – Raised if object{key: value} cannot be found in <cite>collection</cite>.</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="asab.storage.mongodb.StorageService.collection">
<em class="property"><span class="pre">async</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">collection</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">collection</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">AsyncIOMotorCollection</span></span></span><a class="reference internal" href="../_modules/asab/storage/mongodb.html#StorageService.collection"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#asab.storage.mongodb.StorageService.collection" title="Permalink to this definition">¶</a></dt>
<dd><p>Get collection. Useful for custom operations.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>collection</strong> – Collection to get.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>AsyncIOMotorCollection object connected to the queried database.</p>
</dd>
</dl>
<p>Examples:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">coll</span> <span class="o">=</span> <span class="k">await</span> <span class="n">storage</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="s2">&quot;test-collection&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cursor</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">find</span><span class="p">({})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">while</span> <span class="k">await</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetch_next</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">obj</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">next_object</span><span class="p">()</span>
<span class="gp">... </span>    <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

</section>
<section id="elasticsearch-storage">
<h3>ElasticSearch Storage<a class="headerlink" href="#elasticsearch-storage" title="Permalink to this heading">¶</a></h3>
<p>Here is a list of methods that are specific for the ElasticSearch storage.</p>
<dl class="py class">
<dt class="sig sig-object py" id="asab.storage.elasticsearch.StorageService">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">asab.storage.elasticsearch.</span></span><span class="sig-name descname"><span class="pre">StorageService</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">app</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">service_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">config_section_name</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'asab:storage'</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/asab/storage/elasticsearch.html#StorageService"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#asab.storage.elasticsearch.StorageService" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <a class="reference internal" href="#asab.storage.service.StorageServiceABC" title="asab.storage.service.StorageServiceABC"><code class="xref py py-class docutils literal notranslate"><span class="pre">StorageServiceABC</span></code></a></p>
<p>StorageService for Elastic Search. Depends on <cite>aiohttp</cite> library.</p>
<dl class="py method">
<dt class="sig sig-object py" id="asab.storage.elasticsearch.StorageService.session">
<span class="sig-name descname"><span class="pre">session</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/asab/storage/elasticsearch.html#StorageService.session"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#asab.storage.elasticsearch.StorageService.session" title="Permalink to this definition">¶</a></dt>
<dd><p>Get the current client session.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="asab.storage.elasticsearch.StorageService.finalize">
<em class="property"><span class="pre">async</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">finalize</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">app</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/asab/storage/elasticsearch.html#StorageService.finalize"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#asab.storage.elasticsearch.StorageService.finalize" title="Permalink to this definition">¶</a></dt>
<dd><p>Close the current client session.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="asab.storage.elasticsearch.StorageService.mapping">
<em class="property"><span class="pre">async</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">mapping</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">index</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">dict</span></span></span><a class="reference internal" href="../_modules/asab/storage/elasticsearch.html#StorageService.mapping"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#asab.storage.elasticsearch.StorageService.mapping" title="Permalink to this definition">¶</a></dt>
<dd><p>Retrieve mapping definitions for one index.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>index</strong> (<em>str</em>) – Specified index.</p>
</dd>
<dt class="field-even">Raises<span class="colon">:</span></dt>
<dd class="field-even"><p><strong>Exception</strong> – Connection failed.</p>
</dd>
</dl>
<dl class="simple">
<dt>Returns:</dt><dd><p>dict: Mapping definitions for the index.</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="asab.storage.elasticsearch.StorageService.get_index_template">
<em class="property"><span class="pre">async</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">get_index_template</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">template_name</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">dict</span></span></span><a class="reference internal" href="../_modules/asab/storage/elasticsearch.html#StorageService.get_index_template"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#asab.storage.elasticsearch.StorageService.get_index_template" title="Permalink to this definition">¶</a></dt>
<dd><p>Retrieve ECS Index template for the given template name.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>template_name</strong> (<em>str</em>) – The name of the ECS template to retrieve.</p>
</dd>
<dt class="field-even">Raises<span class="colon">:</span></dt>
<dd class="field-even"><p><strong>Exception</strong> – Raised if connection to all server URLs fails.</p>
</dd>
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p>ElasticSearch Index template.</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="asab.storage.elasticsearch.StorageService.put_index_template">
<em class="property"><span class="pre">async</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">put_index_template</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">template_name</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">template</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">dict</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">dict</span></span></span><a class="reference internal" href="../_modules/asab/storage/elasticsearch.html#StorageService.put_index_template"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#asab.storage.elasticsearch.StorageService.put_index_template" title="Permalink to this definition">¶</a></dt>
<dd><p>Create a new ECS index template.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>template_name</strong> – The name of ECS template.</p></li>
<li><p><strong>template</strong> – Body for the request.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>JSON response.</p>
</dd>
<dt class="field-odd">Raises<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>Exception</strong> – Raised if connection to all server URLs fails.</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="asab.storage.elasticsearch.StorageService.reindex">
<em class="property"><span class="pre">async</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">reindex</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">previous_index</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">new_index</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/asab/storage/elasticsearch.html#StorageService.reindex"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#asab.storage.elasticsearch.StorageService.reindex" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="asab.storage.elasticsearch.StorageService.scroll">
<em class="property"><span class="pre">async</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">scroll</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">index</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">body</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">dict</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">dict</span></span></span><a class="reference internal" href="../_modules/asab/storage/elasticsearch.html#StorageService.scroll"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#asab.storage.elasticsearch.StorageService.scroll" title="Permalink to this definition">¶</a></dt>
<dd><p>Retrieve the next batch of results for a scrolling search.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>index</strong> (<em>str</em>) – The index name.</p></li>
<li><p><strong>body</strong> (<em>dict</em>) – Custom body for the request. Defaults to None.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>JSON response.</p>
</dd>
<dt class="field-odd">Raises<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>Exception</strong> – Raised if connection to all server URLs fails.</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="asab.storage.elasticsearch.StorageService.list">
<em class="property"><span class="pre">async</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">list</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">index</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">_from</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">size</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">10000</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">body</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">dict</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">dict</span></span></span><a class="reference internal" href="../_modules/asab/storage/elasticsearch.html#StorageService.list"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#asab.storage.elasticsearch.StorageService.list" title="Permalink to this definition">¶</a></dt>
<dd><p>List data matching the index.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>index</strong> – Specified index.</p></li>
<li><p><strong>_from</strong> (<em>int</em>) – Starting document offset. Defaults to 0.</p></li>
<li><p><strong>size</strong> (<em>int</em>) – The number of hits to return. Defaults to 10000.</p></li>
<li><p><strong>body</strong> (<em>dict</em>) – An optional request body. Defaults to None.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>The query search result.</p>
</dd>
<dt class="field-odd">Raises<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>Exception</strong> – Raised if connection to all server URLs fails.</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="asab.storage.elasticsearch.StorageService.count">
<em class="property"><span class="pre">async</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">count</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">index</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">int</span></span></span><a class="reference internal" href="../_modules/asab/storage/elasticsearch.html#StorageService.count"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#asab.storage.elasticsearch.StorageService.count" title="Permalink to this definition">¶</a></dt>
<dd><p>Get the number of matches for a given index.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>index</strong> – The specified index.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>The number of matches for a given index.</p>
</dd>
<dt class="field-odd">Raises<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>Exception</strong> – Connection failed.</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="asab.storage.elasticsearch.StorageService.indices">
<em class="property"><span class="pre">async</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">indices</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">search_string</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/asab/storage/elasticsearch.html#StorageService.indices"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#asab.storage.elasticsearch.StorageService.indices" title="Permalink to this definition">¶</a></dt>
<dd><p>Return high-level information about indices in a cluster, including backing indices for data streams.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>search_string</strong> – A search string. Default to None.</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="asab.storage.elasticsearch.StorageService.empty_index">
<em class="property"><span class="pre">async</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">empty_index</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">index</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/asab/storage/elasticsearch.html#StorageService.empty_index"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#asab.storage.elasticsearch.StorageService.empty_index" title="Permalink to this definition">¶</a></dt>
<dd><p>Create an empty ECS index.</p>
</dd></dl>

</dd></dl>

</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">ASAB</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../get-started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/web/chapter1.html">Web Server Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/web/chapter2.html">Create microservice with REST API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Services</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="web/index.html">The web server</a></li>
<li class="toctree-l1"><a class="reference internal" href="web/restapidocs.html">REST API Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="web/cors.html">Cross-Origin Resource Sharing (CORS)</a></li>
<li class="toctree-l1"><a class="reference internal" href="metrics.html">Metrics</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Storage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#configuration">Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#manipulation-with-databases">Manipulation with databases</a></li>
<li class="toctree-l2"><a class="reference internal" href="#storing-data-in-memory">Storing data in memory</a></li>
<li class="toctree-l2"><a class="reference internal" href="#storing-data-in-mongodb">Storing data in MongoDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="#storing-data-in-elasticsearch">Storing data in ElasticSearch</a></li>
<li class="toctree-l2"><a class="reference internal" href="#encryption-and-decryption">Encryption and decryption</a></li>
<li class="toctree-l2"><a class="reference internal" href="#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="alert.html">Alert Service</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="application.html">Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="config.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="log.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="pubsub.html">Publish-Subscribe</a></li>
<li class="toctree-l1"><a class="reference internal" href="service.html">Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="module.html">Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="various.html">Various utility classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="zookeeper.html">Zookeeper</a></li>
<li class="toctree-l1"><a class="reference internal" href="library.html">Library</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Administration</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../admin/install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin/command-line.html">ASAB Command-line interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin/containers.html">Containerisation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin/systemd.html">systemd</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="metrics.html" title="previous chapter">Metrics</a></li>
      <li>Next: <a href="alert.html" title="next chapter">Alert Service</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, TeskaLabs Ltd..
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 6.1.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../_sources/asab/storage.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>